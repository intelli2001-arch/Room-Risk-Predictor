import pandas as pd
from sklearn.ensemble import RandomForestClassifier
from datetime import datetime

class PracticeRoomPredictor:
    def __init__(self, csv_path):
        # 1. ë°ì´í„° ë¡œë“œ ë° ëª¨ë¸ í•™ìŠµ
        self.df = pd.read_csv(csv_path)
        self.features = ['ì›”', 'ì¼', 'ìš”ì¼', 'ì‹œê°„', 'íœ´ì¼ ì—¬ë¶€', 'ì‹œí—˜ê¸°ê°„ ì—¬ë¶€', 'ê³µì—°ì‹œì¦Œ ì—¬ë¶€']
        self.model = self._train_model()
        
        # 2. 2026ë…„ ê¸°ì¤€ ì£¼ìš” ì¼ì • ì„¤ì • (ìë™ íŒë‹¨ìš©)
        self.holidays_2026 = [
            '2026-01-01', '2026-03-01', '2026-03-02', '2026-05-05', 
            '2026-05-24', '2026-06-06', '2026-08-15', '2026-10-03', '2026-10-09', '2026-12-25'
        ]
        self.exam_periods_2026 = [('2026-04-13', '2026-04-24'), ('2026-06-08', '2026-06-19')]
        self.perf_seasons_2026 = [('2026-05-11', '2026-06-05')]

    def _train_model(self):
        X = self.df[self.features]
        y = self.df['ì˜ˆì•½ ì—¬ë¶€']
        model = RandomForestClassifier(n_estimators=100, random_state=42)
        model.fit(X, y)
        return model

    def _is_in_period(self, target_date, periods):
        for start_str, end_str in periods:
            start = datetime.strptime(start_str, '%Y-%m-%d').date()
            end = datetime.strptime(end_str, '%Y-%m-%d').date()
            if start <= target_date.date() <= end:
                return 1
        return 0

    def predict(self, date_str, hour):
        """ë‚ ì§œ(YYYY-MM-DD)ì™€ ì‹œê°„(9~22)ì„ ì…ë ¥ë°›ì•„ í™•ë¥ ì„ ê³„ì‚°"""
        target_dt = datetime.strptime(date_str, '%Y-%m-%d')
        month, day, weekday = target_dt.month, target_dt.day, target_dt.weekday()
        
        # ì‹œì¦Œ ë° íœ´ì¼ ìë™ íŒë‹¨
        is_holiday = 1 if (weekday >= 5 or date_str in self.holidays_2026) else 0
        is_exam = self._is_in_period(target_dt, self.exam_periods_2026)
        is_perf = self._is_in_period(target_dt, self.perf_seasons_2026)
        
        # ëª¨ë¸ ì…ë ¥ ë°ì´í„° ìƒì„±
        input_data = pd.DataFrame([[
            month, day, weekday, hour, is_holiday, is_exam, is_perf
        ]], columns=self.features)
        
        # í™•ë¥  ì‚°ì¶œ (í´ë˜ìŠ¤ 1: ë§ˆê°ë  í™•ë¥ )
        prob = self.model.predict_proba(input_data)[0][1]
        
        # ê°€ë…ì„± ìˆëŠ” ë¦¬í¬íŠ¸ ë°˜í™˜
        status = "ğŸ”´ í˜¼ì¡" if prob >= 0.7 else ("ğŸŸ¡ ë³´í†µ" if prob >= 0.4 else "ğŸŸ¢ ì—¬ìœ ")
        return {
            "ë¶„ì„_ì¼ì‹œ": f"{date_str} {hour:02d}:00",
            "íŒë‹¨_ê²°ê³¼": {"íœ´ì¼": is_holiday, "ì‹œí—˜ê¸°ê°„": is_exam, "ê³µì—°ì‹œì¦Œ": is_perf},
            "ë§ˆê°_í™•ë¥ ": f"{prob * 100:.1f}%",
            "ì˜ˆì¸¡_ìƒíƒœ": status
        }

# --- ì—”ì§„ ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸ ---
engine = PracticeRoomPredictor('/content/practice_room_ML_data_2025.csv')

# ì˜ˆì‹œ: 2026ë…„ 4ì›” 20ì¼(ì‹œí—˜ê¸°ê°„ ì›”ìš”ì¼) 19ì‹œ ì˜ˆì¸¡
result = engine.predict("2026-04-20", 19)
print(result)